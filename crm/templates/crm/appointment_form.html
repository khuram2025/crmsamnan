{% extends "partials/base.html" %} {% load static %} {% block title %}Create Appointment - Channab{% endblock title %} {% block extra_css %}
<style>
  .customer-info .form-group {
    margin-bottom: 15px;
  }
  .customer-info .form-group label {
    display: block;
    margin-bottom: 5px;
  }
  .customer-info .form-group select,
  .customer-info .form-group input[type="text"],
  .customer-info .form-group input[type="tel"],
  .customer-info .form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  .customer-info .form-group textarea {
    resize: vertical;
  }
  .calendar {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  .calendar th,
  .calendar td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  .calendar .day {
    cursor: pointer;
  }
  .calendar .day:hover {
    background-color: #f0f0f0;
  }
  .calendar .selected {
    background-color: #007bff;
    color: white;
  }
  .calendar .has-slots::after {
    content: "â€¢";
    display: block;
    color: #007bff;
  }
  .calendar .muted {
    color: #ccc;
    cursor: not-allowed;
  }
  .time-slots {
    display: none;
    margin-top: 20px;
  }
  .time-slot {
    display: inline-block;
    padding: 8px 12px;
    margin: 5px;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  .time-slot:hover {
    background-color: #0056b3;
  }
  .time-slot.selected {
    background-color: #28a745;
  }
</style>
{% endblock extra_css %} {% block content %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-xl-4 customer-info">
          <h2>Appointment Information</h2>
          <form id="appointmentForm" method="post">
            {% csrf_token %}
            <div class="form-group">
              <label for="id_city">City</label>
              {{ form.city }}
            </div>
            <div class="form-group">
              <label for="id_area">Area</label>
              {{ form.area }}
            </div>
            <div class="form-group">
              <label for="id_technician">Technician</label>
              {{ form.technician }}
            </div>
            <div class="form-group">
              <label for="id_name">Name</label>
              {{ form.name }}
            </div>
            <div class="form-group">
              <label for="id_mobile_number">Mobile Number</label>
              {{ form.mobile_number }}
            </div>
            <div class="form-group">
              <label for="id_notes">Notes</label>
              {{ form.notes }}
            </div>
            <div class="form-group">
              <label for="id_service">Service</label>
              <select id="id_service" name="service" class="form-control">
                <option value="">Select Service</option>
                <option value="cbp">Complete Blood Picture (CBP)</option>
                <option value="health-men-test">Health Men Test</option>
              </select>
            </div>
            {{ form.date }} {{ form.slot }}
          </form>
        </div>

        <div class="col-xl-4">
          <h2>Select Appointment Date</h2>
          <table class="calendar" id="appointment-calendar">
            <thead>
              <tr>
                <th colspan="7">
                  <span class="prev">&lt;</span>
                  <span id="current-month"></span>
                  <span class="next">&gt;</span>
                </th>
              </tr>
              <tr>
                <th>S</th>
                <th>M</th>
                <th>T</th>
                <th>W</th>
                <th>T</th>
                <th>F</th>
                <th>S</th>
              </tr>
            </thead>
            <tbody>
              <!-- Calendar days will be dynamically inserted here -->
            </tbody>
          </table>

          <div id="time-slots" class="time-slots">
            <!-- Time slots will be dynamically inserted here -->
          </div>
        </div>

        <div class="col-xl-4">
          <h2>Appointment Details</h2>
          <div id="appointmentSummary"></div>
          <button type="submit" class="btn btn-primary mt-3" form="appointmentForm">Create Appointment</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %} {% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    const calendar = document.getElementById("appointment-calendar");
    const timeSlots = document.getElementById("time-slots");
    let currentDate = new Date();

    function generateCalendar(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const tbody = calendar.querySelector("tbody");
      tbody.innerHTML = "";

      let date = new Date(firstDay);
      date.setDate(date.getDate() - date.getDay());

      while (date <= lastDay || date.getDay() !== 0) {
        const row = tbody.insertRow();
        for (let i = 0; i < 7; i++) {
          const cell = row.insertCell();
          if (date.getMonth() === month) {
            cell.textContent = date.getDate();
            cell.classList.add("day");
            if (date < new Date(new Date().setHours(0, 0, 0, 0))) {
              cell.classList.add("muted");
            } else {
              cell.classList.add("has-slots");
              cell.addEventListener("click", (event) => {
                const clickedDate = new Date(year, month, parseInt(event.target.textContent));
                console.log(`Clicked date: ${formatDate(clickedDate)}`); // Debug log
                selectDate(clickedDate);
              });
            }
          }
          date.setDate(date.getDate() + 1);
        }
      }
      document.getElementById("current-month").textContent = `${new Date(year, month).toLocaleString("default", { month: "long" })} ${year}`;
    }

    function formatDate(date) {
      const d = new Date(date);
      let month = "" + (d.getMonth() + 1);
      let day = "" + d.getDate();
      const year = d.getFullYear();

      if (month.length < 2) month = "0" + month;
      if (day.length < 2) day = "0" + day;

      return [year, month, day].join("-");
    }

    function selectDate(date) {
      const selectedCell = calendar.querySelector(".selected");
      if (selectedCell) {
        selectedCell.classList.remove("selected");
      }
      event.target.classList.add("selected");

      const formattedDate = formatDate(date);
      document.getElementById("id_date").value = formattedDate;
      console.log(`Date selected from calendar: ${formattedDate}`); // Debug log
      loadTimeSlots(formattedDate);
    }

    function loadTimeSlots(date) {
      const technicianId = document.getElementById("id_technician").value;
      if (!technicianId) {
        console.log("No technician selected"); // Debug log
        alert("Please select a technician first.");
        return;
      }

      console.log(`Loading time slots for technician ${technicianId} on ${date}`); // Debug log

      $.ajax({
        url: '{% url "ajax_load_slots" %}',
        data: {
          technician_id: technicianId,
          date: date,
        },
        success: function (data) {
          console.log("Received slots data:", data); // Debug log
          timeSlots.innerHTML = "<h3>Available Time Slots</h3>";
          const slotsContainer = document.createElement("div");
          if (Array.isArray(data) && data.length > 0) {
            data.forEach(function (slot) {
              const button = document.createElement("button");
              button.textContent = `${slot.start_time} - ${slot.end_time}`;
              button.classList.add("time-slot");
              button.addEventListener("click", () => selectTimeSlot(slot.id, button.textContent));
              slotsContainer.appendChild(button);
            });
          } else {
            slotsContainer.textContent = "No available slots for this date.";
          }
          timeSlots.appendChild(slotsContainer);
          timeSlots.style.display = "block";
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error); // Debug log
          console.error("Response Text:", xhr.responseText); // Debug log
        },
      });
    }

    function selectTimeSlot(slotId, slotText) {
      const slotSelect = document.getElementById("id_slot");

      // Create a new option
      const option = document.createElement("option");
      option.value = slotId;
      option.text = slotText;
      option.selected = true;

      // Remove all existing options
      slotSelect.innerHTML = "";

      // Add the new option
      slotSelect.add(option);

      const selectedSlot = timeSlots.querySelector(".selected");
      if (selectedSlot) {
        selectedSlot.classList.remove("selected");
      }
      event.target.classList.add("selected");
      updateSummary();
      console.log(`Selected slot ID: ${slotId}`); // Debug log
    }

    function loadTimeSlots(date) {
      const technicianId = document.getElementById("id_technician").value;
      if (!technicianId) {
        console.log("No technician selected"); // Debug log
        alert("Please select a technician first.");
        return;
      }

      console.log(`Loading time slots for technician ${technicianId} on ${date}`); // Debug log

      $.ajax({
        url: '{% url "ajax_load_slots" %}',
        data: {
          technician_id: technicianId,
          date: date,
        },
        success: function (data) {
          console.log("Received slots data:", data); // Debug log
          timeSlots.innerHTML = "<h3>Available Time Slots</h3>";
          const slotsContainer = document.createElement("div");
          if (Array.isArray(data) && data.length > 0) {
            data.forEach(function (slot) {
              const button = document.createElement("button");
              button.textContent = `${slot.start_time} - ${slot.end_time}`;
              button.classList.add("time-slot");
              button.addEventListener("click", () => selectTimeSlot(slot.id, button.textContent));
              slotsContainer.appendChild(button);
            });
          } else {
            slotsContainer.textContent = "No available slots for this date.";
          }
          timeSlots.appendChild(slotsContainer);
          timeSlots.style.display = "block";
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error); // Debug log
          console.error("Response Text:", xhr.responseText); // Debug log
        },
      });
    }
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

    document.querySelector(".prev").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    document.querySelector(".next").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    $("#id_city").change(function () {
      var cityId = $(this).val();
      console.log("Selected city ID:", cityId);
      $.ajax({
        url: '{% url "ajax_load_areas" %}',
        data: {
          city_id: cityId,
        },
        success: function (data) {
          console.log("Received areas data:", data);
          $("#id_area").html('<option value="">Select an area</option>');
          $.each(data, function (index, item) {
            $("#id_area").append($("<option></option>").val(item.id).html(item.name));
          });
          $("#id_technician").html('<option value="">Select a technician</option>');
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error);
          console.error("Response Text:", xhr.responseText);
        },
      });
    });

    $("#id_area").change(function () {
      var areaId = $(this).val();
      $.ajax({
        url: '{% url "ajax_load_technicians" %}',
        data: {
          area_id: areaId,
        },
        success: function (data) {
          $("#id_technician").html('<option value="">Select a technician</option>');
          $.each(data, function (index, item) {
            $("#id_technician").append($("<option></option>").val(item.id).html(item.name));
          });
        },
      });
    });

    $("#id_technician").change(function () {
      var selectedDate = $("#id_date").val();
      if (selectedDate) {
        loadTimeSlots(new Date(selectedDate));
      }
    });

    function updateSummary() {
      var summary = "<ul>";
      summary += `<li><strong>City:</strong> ${$("#id_city option:selected").text()}</li>`;
      summary += `<li><strong>Area:</strong> ${$("#id_area option:selected").text()}</li>`;
      summary += `<li><strong>Technician:</strong> ${$("#id_technician option:selected").text()}</li>`;
      summary += `<li><strong>Customer:</strong> ${$("#id_name").val()} (${$("#id_mobile_number").val()})</li>`;
      summary += `<li><strong>Date:</strong> ${$("#id_date").val()}</li>`;
      summary += `<li><strong>Time Slot:</strong> ${$(".time-slot.selected").text()}</li>`;
      summary += `<li><strong>Service:</strong> ${$("#id_service option:selected").text()}</li>`;
      summary += `<li><strong>Notes:</strong> ${$("#id_notes").val()}</li>`;
      summary += "</ul>";
      $("#appointmentSummary").html(summary);
    }

    $("#appointmentForm").change(updateSummary);
  });
</script>
{% endblock extra_js %}
