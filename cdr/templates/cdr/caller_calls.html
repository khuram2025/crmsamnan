{% extends "partials/base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}Calls for {{ caller_number }}{% endblock title %}
{% block extra_css %}
<!-- Add this line if it's not already present -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock extra_css %}
{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row mb-3 pb-1">
                <div class="col-12">
                    <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                        <div class="flex-grow-1">
        <div class="d-flex align-items-center">
            <h4 class="fs-16 mb-1 me-3">Calls for {{ caller_number }}</h4>
            <a href="{% url 'cdr3cx:caller_calls' caller_number %}?date_filter={{ date_filter }}&custom_date={{ custom_date_range }}&search={{ search_query }}&export_excel=true" class="btn btn-primary btn-sm">
                Export to Excel
            </a>
        </div>
        <p class="text-muted mb-0">Here's what's happening with this extension.</p>
    </div>
                        <div class="mt-3 mt-lg-0">
                            <form id="timePeriodForm" action="{% url 'cdr3cx:caller_calls' caller_number %}" method="GET">
                                <div class="row g-3 mb-0 align-items-center">
                                    <div class="col-auto">
                                        <div>
                                            <button type="button" name="date_filter" value="today" class="btn btn-soft-secondary material-shadow-none btn-sm {% if date_filter == 'today' %}active{% endif %}">Today</button>
                                            <button type="button" name="date_filter" value="7d" class="btn btn-soft-secondary material-shadow-none btn-sm {% if date_filter == '7d' %}active{% endif %}">7D</button>
                                            <button type="button" name="date_filter" value="1M" class="btn btn-soft-secondary material-shadow-none btn-sm {% if date_filter == '1M' %}active{% endif %}">1M</button>
                                            <button type="button" name="date_filter" value="6M" class="btn btn-soft-secondary material-shadow-none btn-sm {% if date_filter == '6M' %}active{% endif %}">6M</button>
                                            <button type="button" name="date_filter" value="1Y" class="btn btn-soft-primary material-shadow-none btn-sm {% if date_filter == '1Y' %}active{% endif %}">1Y</button>
                                            <input type="hidden" name="date_filter" value="{{ date_filter }}">
                                            <input type="hidden" name="per_page" value="{{ per_page }}">
                                            <input type="hidden" name="search" value="{{ search_query }}">
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="input-group">
                                            <input type="text" class="form-control border-0 minimal-border dash-filter-picker shadow flatpickr-input" name="custom_date" id="customDateInput" data-provider="flatpickr" data-range-date="true" data-date-format="d M, Y" placeholder="Select custom date range" value="{{ custom_date_range }}" />
                                            <div class="input-group-text bg-primary border-primary text-white">
                                                <i class="ri-calendar-2-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-soft-info btn-icon waves-effect waves-light material-shadow-none layout-rightside-btn">
                                            <i class="ri-pulse-line"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Total Calls</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-success fs-14 mb-0"><i class="ri-arrow-right-up-line fs-13 align-middle"></i> {{ total_cost|floatformat:2 }} SAR</h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_calls }}">{{ total_calls }}</span></h4>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-success-subtle rounded fs-3">
                                        <i class="fas fa-phone-alt text-success"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Local Calls</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-danger fs-14 mb-0"><i class="ri-arrow-right-down-line fs-13 align-middle"></i> {{ local_call_cost|floatformat:2 }} SAR</h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_local_calls }}">0</span></h4>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-info-subtle rounded fs-3">
                                        <i class="fas fa-phone-alt text-info"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Incoming Calls</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-success fs-14 mb-0"><i class="ri-arrow-right-up-line fs-13 align-middle"></i> {{ incoming_call_cost|floatformat:2 }} SAR</h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_incoming_calls }}">0</span></h4>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-warning-subtle rounded fs-3">
                                        <i class="bx bx-mobile-alt text-info"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">International Calls</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="text-muted fs-14 mb-0">{{ international_call_cost|floatformat:2 }} SAR</h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold ff-secondary mb-4"><span class="counter-value" data-target="{{ total_international_calls }}">0</span></h4>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-primary-subtle rounded fs-3">
                                        <i class="bx bx-globe text-primary"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header border-0 align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Call Details</h4>
                            <div class="d-flex gap-1">
                                <form method="GET" action="{% url 'cdr3cx:caller_calls' caller_number %}" class="d-flex align-items-center">
                                    <label class="me-2">Show</label>
                                    <select name="per_page" aria-controls="caller-calls-table" class="form-select form-select-sm" onchange="this.form.submit()">
                                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                    </select>
                                    <span class="ms-2">entries</span>
                                    <input type="hidden" name="search" value="{{ search_query }}">
                                    <input type="hidden" name="date_filter" value="{{ date_filter }}">
                                    <input type="hidden" name="custom_date" value="{{ custom_date_range }}">
                                </form>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="caller-calls-table_wrapper" class="dataTables_wrapper dt-bootstrap5">
                                <div class="row align-items-center mb-3">
                                    <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
                                        <form method="GET" action="{% url 'cdr3cx:caller_calls' caller_number %}" class="d-flex align-items-center">
                                            <label class="me-2">Search:</label>
                                            <input type="search" name="search" class="form-control form-control-sm" placeholder="" aria-controls="caller-calls-table" value="{{ search_query }}" oninput="this.form.submit()">
                                            <input type="hidden" name="per_page" value="{{ per_page }}">
                                            <input type="hidden" name="date_filter" value="{{ date_filter }}">
                                            <input type="hidden" name="custom_date" value="{{ custom_date_range }}">
                                        </form>
                                    </div>
                                </div>

                                <table id="caller-calls-table" class="table table-bordered dt-responsive nowrap table-striped align-middle">
                                    <thead>
                                        <tr>
                                            <th>Call Time</th>
                                            <th>Callee</th>
                                            <th>Duration</th>
                                            <th>Call Type</th>
                                            <th>Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for call in page_obj %}
                                        <tr>
                                            <td>{{ call.call_time|date:"d M, Y H:i:s" }}</td>
                                            <td>{{ call.callee }}</td>
                                            <td>{{ call.duration|format_duration }}</td>
                                            <td>{{ call.to_type }}</td>
                                            <td>{{ call.total_cost|floatformat:2 }} SAR</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center">No calls found matching the current filters.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                                <div class="row">
                                    <div class="col-sm-12 col-md-5">
                                        <div class="dataTables_info" id="caller-calls-table_info" role="status" aria-live="polite">
                                            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} entries
                                        </div>
                                    </div>
                                    <div class="col-sm-12 col-md-7">
                                        <div class="dataTables_paginate paging_simple_numbers" id="caller-calls-table_paginate">
                                            <ul class="pagination">
                                                {% if page_obj.has_previous %}
                                                <li class="paginate_button page-item previous">
                                                    <a href="?page=1&per_page={{ per_page }}&search={{ search_query }}&date_filter={{ date_filter }}&custom_date={{ custom_date_range }}" class="page-link">First</a>
                                                </li>
                                                <li class="paginate_button page-item previous">
                                                    <a href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}&search={{ search_query }}&date_filter={{ date_filter }}&custom_date={{ custom_date_range }}" class="page-link">Previous</a>
                                                </li>
                                                {% endif %}

                                                {% for num in page_obj.paginator.page_range %}
                                                {% if page_obj.number == num %}
                                                <li class="paginate_button page-item active">
                                                    <a href="?page={{ num }}&per_page={{ per_page }}&search={{ search_query }}&date_filter={{ date_filter }}&custom_date={{ custom_date_range }}" class="page-link">{{ num }}</a>
                                                </li>
                                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                                <li class="paginate_button page-item">
                                                    <a href="?page={{ num }}&per_page={{ per_page }}&search={{ search_query }}&date_filter={{ date_filter }}&custom_date={{ custom_date_range }}" class="page-link">{{ num }}</a>
                                                </li>
                                                {% endif %}
                                                {% endfor %}

                                                {% if page_obj.has_next %}
                                                <li class="paginate_button page-item next">
                                                    <a href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}&search={{ search_query }}&date_filter={{ date_filter }}&custom_date={{ custom_date_range }}" class="page-link">Next</a>
                                                </li>
                                                <li class="paginate_button page-item next">
                                                    <a href="?page={{ page_obj.paginator.num_pages }}&per_page={{ per_page }}&search={{ search_query }}&date_filter={{ date_filter }}&custom_date={{ custom_date_range }}" class="page-link">Last</a>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
<script>
    function animateCounter(element, target, duration = 1000) {
        const start = parseInt(element.textContent) || 0;
        const end = parseInt(target);

        // If start and end are the same, or end is 0, just set the value and return
        if (start === end || end === 0) {
            element.textContent = end;
            return;
        }

        const range = Math.abs(end - start);
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));

        const timer = setInterval(() => {
            current += increment;
            element.textContent = current;
            if (current == end) {
                clearInterval(timer);
            }
        }, stepTime);
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.counter-value').forEach(counter => {
            const target = counter.getAttribute('data-target');
            animateCounter(counter, target);
        });

        flatpickr("#customDateInput", {
            mode: "range",
            dateFormat: "d M, Y",
            onChange: function (selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    document.getElementById('timePeriodForm').submit();
                }
            }
        });
    });
</script>
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const customDateInput = document.getElementById('customDateInput');
        const timePeriodForm = document.getElementById('timePeriodForm');

        // Initialize Flatpickr
        const flatpickrInstance = flatpickr("#customDateInput", {
            mode: "range",
            dateFormat: "d M, Y",
            onChange: function (selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    document.querySelector('input[name="date_filter"]').value = 'custom';
                    timePeriodForm.submit();
                }
            }
        });

        // Add click event listeners to all filter buttons
        document.querySelectorAll('button[name="date_filter"]').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                // Clear the custom date input
                customDateInput.value = '';
                flatpickrInstance.clear();
                // Set the date_filter value
                document.querySelector('input[name="date_filter"]').value = this.value;
                // Submit the form
                timePeriodForm.submit();
            });
        });

        // Counter animation code
        function animateCounter(element, target, duration = 1000) {
            const start = parseInt(element.textContent) || 0;
            const end = parseInt(target);

            if (start === end || end === 0) {
                element.textContent = end;
                return;
            }

            const range = Math.abs(end - start);
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));

            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        document.querySelectorAll('.counter-value').forEach(counter => {
            const target = counter.getAttribute('data-target');
            animateCounter(counter, target);
        });
    });
</script>
{% endblock extra_js %}
{% endblock javascript %}