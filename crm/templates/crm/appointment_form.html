{% extends "partials/base.html" %} {% load static %} {% block title %}Create Appointment - Channab{% endblock title %} {% block extra_css %}
<style>
  .customer-info .form-group {
    margin-bottom: 15px;
  }
  .customer-info .form-group label {
    display: block;
    margin-bottom: 5px;
  }
  .customer-info .form-group select,
  .customer-info .form-group input[type="text"],
  .customer-info .form-group input[type="tel"],
  .customer-info .form-group textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  .customer-info .form-group textarea {
    resize: vertical;
  }
  .calendar {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  .calendar th,
  .calendar td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  .calendar .day {
    cursor: pointer;
  }
  .calendar .day:hover {
    background-color: #f0f0f0;
  }
  .calendar .selected {
    background-color: #405189;
    color: white;
  }
  .calendar .has-slots::after {
    content: "â€¢";
    display: block;
    color: #405189;
  }
  .calendar .muted {
    color: #ccc;
    cursor: not-allowed;
  }
  .time-slots {
    display: none;
    margin-top: 20px;
  }
  
  /* Remove border and add some spacing */
  .time-slots h3 {
    margin-bottom: 15px;
  }
  
  /* Style for the container of time slot buttons */
  .time-slots > div {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .time-slot {
    display: inline-block;
    padding: 8px 12px;
    background-color: #405189;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    border: none; /* Ensure no border on the buttons */
  }
  
  .time-slot:hover {
    background-color: #506399;
  }
  
  .time-slot.selected {
    background-color: #0ab39c;
  }

  .appointment-details {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .appointment-details h2 {
    color: #405189;
    margin-bottom: 20px;
    font-weight: 600;
  }

  .appointment-summary {
    list-style-type: none;
    padding: 0;
  }

  .appointment-summary li {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
  }

  .appointment-summary .label {
    font-weight: 600;
    min-width: 120px;
    color: #555;
  }

  .appointment-summary .value {
    flex: 1;
    color: #333;
  }

  .create-appointment-btn {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    font-weight: 600;
    margin-top: 20px;
    background-color: #405189;
    border: none;
    transition: background-color 0.3s ease;
  }

  .create-appointment-btn:hover {
    background-color: #324376;
  }

  .appointment-details-container {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .appointment-details-content {
    flex-grow: 1;
  }
</style>

{% endblock extra_css %} {% block content %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-xl-4 customer-info">
          <h2>{% if edit_mode %}Edit{% else %}Create{% endif %} Appointment</h2>
          <form id="appointmentForm" method="post">
            {% csrf_token %}
            <div class="form-group">
              <label for="id_city">City</label>
              {{ form.city }}
            </div>
            <div class="form-group">
              <label for="id_area">Area</label>
              {{ form.area }}
            </div>
            <div class="form-group">
              <label for="id_technician">Technician</label>
              {{ form.technician }}
            </div>
            <div class="form-group">
              <label for="id_name">Name</label>
              {{ form.name }}
            </div>
            <div class="form-group">
              <label for="id_mobile_number">Mobile Number</label>
              {{ form.mobile_number }}
            </div>
            <div class="form-group">
              <label for="id_notes">Notes</label>
              {{ form.notes }}
            </div>
            <div class="form-group">
              <label for="id_service">Service(s)</label>
              {{ form.service }}
            </div>
            <div style="display: none;">
                {{ form.date }} {{ form.slot }}
            </div>
          </form>
        </div>

        <div class="col-xl-4">
          <h2>Select Appointment Date</h2>
          <table class="calendar" id="appointment-calendar">
            <thead>
              <tr>
                <th colspan="7">
                  <span class="prev">&lt;</span>
                  <span id="current-month"></span>
                  <span class="next">&gt;</span>
                </th>
              </tr>
              <tr>
                <th>S</th>
                <th>M</th>
                <th>T</th>
                <th>W</th>
                <th>T</th>
                <th>F</th>
                <th>S</th>
              </tr>
            </thead>
            <tbody>
              <!-- Calendar days will be dynamically inserted here -->
            </tbody>
          </table>

          <div id="time-slots" class="time-slots">
            <!-- Time slots will be dynamically inserted here -->
          </div>
        </div>

        <div class="col-xl-4">
          <div class="appointment-details-container">
            <div class="appointment-details-content">
              <div class="appointment-details">
                <h2>Appointment Details</h2>
                <ul id="appointmentSummary" class="appointment-summary"></ul>
              </div>
            </div>
            <button type="submit" class="btn btn-primary create-appointment-btn" form="appointmentForm">Create Appointment</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %} {% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    const calendar = document.getElementById("appointment-calendar");
    const timeSlots = document.getElementById("time-slots");
    let currentDate = new Date();

    function generateCalendar(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const tbody = calendar.querySelector("tbody");
      tbody.innerHTML = "";

      let date = new Date(firstDay);
      date.setDate(date.getDate() - date.getDay());

      while (date <= lastDay || date.getDay() !== 0) {
        const row = tbody.insertRow();
        for (let i = 0; i < 7; i++) {
          const cell = row.insertCell();
          if (date.getMonth() === month) {
            cell.textContent = date.getDate();
            cell.classList.add("day");
            if (date < new Date(new Date().setHours(0, 0, 0, 0))) {
              cell.classList.add("muted");
            } else {
              cell.classList.add("has-slots");
              cell.addEventListener("click", (event) => {
                const clickedDate = new Date(year, month, parseInt(event.target.textContent));
                console.log(`Clicked date: ${formatDate(clickedDate)}`); // Debug log
                selectDate(clickedDate);
              });
            }
          }
          date.setDate(date.getDate() + 1);
        }
      }
      document.getElementById("current-month").textContent = `${new Date(year, month).toLocaleString("default", { month: "long" })} ${year}`;
    }

    function formatDate(date) {
      const d = new Date(date);
      let month = "" + (d.getMonth() + 1);
      let day = "" + d.getDate();
      const year = d.getFullYear();

      if (month.length < 2) month = "0" + month;
      if (day.length < 2) day = "0" + day;

      return [year, month, day].join("-");
    }

    function selectDate(date) {
      const selectedCell = calendar.querySelector(".selected");
      if (selectedCell) {
        selectedCell.classList.remove("selected");
      }
      event.target.classList.add("selected");

      const formattedDate = formatDate(date);
      document.getElementById("id_date").value = formattedDate;
      console.log(`Date selected from calendar: ${formattedDate}`); // Debug log
      loadTimeSlots(formattedDate);
    }

    function loadTimeSlots(date) {
      const technicianId = document.getElementById("id_technician").value;
      if (!technicianId) {
        console.log("No technician selected"); // Debug log
        alert("Please select a technician first.");
        return;
      }

      console.log(`Loading time slots for technician ${technicianId} on ${date}`); // Debug log

      $.ajax({
        url: '{% url "ajax_load_slots" %}',
        data: {
          technician_id: technicianId,
          date: date,
        },
        success: function (data) {
          console.log("Received slots data:", data); // Debug log
          timeSlots.innerHTML = "<h3>Available Time Slots</h3>";
          const slotsContainer = document.createElement("div");
          if (Array.isArray(data) && data.length > 0) {
            data.forEach(function (slot) {
              const button = document.createElement("button");
              button.textContent = `${slot.start_time} - ${slot.end_time}`;
              button.classList.add("time-slot");
              button.addEventListener("click", () => selectTimeSlot(slot.id, button.textContent));
              slotsContainer.appendChild(button);
            });
          } else {
            slotsContainer.textContent = "No available slots for this date.";
          }
          timeSlots.appendChild(slotsContainer);
          timeSlots.style.display = "block";
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error); // Debug log
          console.error("Response Text:", xhr.responseText); // Debug log
        },
      });
    }

    function selectTimeSlot(slotId, slotText) {
      const slotSelect = document.getElementById("id_slot");

      // Create a new option
      const option = document.createElement("option");
      option.value = slotId;
      option.text = slotText;
      option.selected = true;

      // Remove all existing options
      slotSelect.innerHTML = "";

      // Add the new option
      slotSelect.add(option);

      const selectedSlot = timeSlots.querySelector(".selected");
      if (selectedSlot) {
        selectedSlot.classList.remove("selected");
      }
      event.target.classList.add("selected");
      updateSummary();
      console.log(`Selected slot ID: ${slotId}`); // Debug log
    }

    function loadTimeSlots(date) {
      const technicianId = document.getElementById("id_technician").value;
      if (!technicianId) {
        console.log("No technician selected"); // Debug log
        alert("Please select a technician first.");
        return;
      }

      console.log(`Loading time slots for technician ${technicianId} on ${date}`); // Debug log

      $.ajax({
        url: '{% url "ajax_load_slots" %}',
        data: {
          technician_id: technicianId,
          date: date,
        },
        success: function (data) {
          console.log("Received slots data:", data); // Debug log
          timeSlots.innerHTML = "<h3>Available Time Slots</h3>";
          const slotsContainer = document.createElement("div");
          if (Array.isArray(data) && data.length > 0) {
            data.forEach(function (slot) {
              const button = document.createElement("button");
              button.textContent = `${slot.start_time} - ${slot.end_time}`;
              button.classList.add("time-slot");
              button.addEventListener("click", () => selectTimeSlot(slot.id, button.textContent));
              slotsContainer.appendChild(button);
            });
          } else {
            slotsContainer.textContent = "No available slots for this date.";
          }
          timeSlots.appendChild(slotsContainer);
          timeSlots.style.display = "block";
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error); // Debug log
          console.error("Response Text:", xhr.responseText); // Debug log
        },
      });
    }
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

    document.querySelector(".prev").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    document.querySelector(".next").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    $("#id_city").change(function () {
      var cityId = $(this).val();
      console.log("Selected city ID:", cityId);
      $.ajax({
        url: '{% url "ajax_load_areas" %}',
        data: {
          city_id: cityId,
        },
        success: function (data) {
          console.log("Received areas data:", data);
          $("#id_area").html('<option value="">Select an area</option>');
          $.each(data, function (index, item) {
            $("#id_area").append($("<option></option>").val(item.id).html(item.name));
          });
          $("#id_technician").html('<option value="">Select a technician</option>');
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error);
          console.error("Response Text:", xhr.responseText);
        },
      });
    });

    $("#id_area").change(function () {
      var areaId = $(this).val();
      $.ajax({
        url: '{% url "ajax_load_technicians" %}',
        data: {
          area_id: areaId,
        },
        success: function (data) {
          $("#id_technician").html('<option value="">Select a technician</option>');
          $.each(data, function (index, item) {
            $("#id_technician").append($("<option></option>").val(item.id).html(item.name));
          });
        },
      });
    });

    $("#id_technician").change(function () {
      var technicianId = $(this).val();
      if (technicianId) {
        loadTechnicianServices(technicianId);
        var selectedDate = $("#id_date").val();
        if (selectedDate) {
          loadTimeSlots(new Date(selectedDate));
        }
      } else {
        $("#id_service").html('<option value="">Select a technician first</option>');
      }
    });

    function loadTechnicianServices(technicianId) {
      $.ajax({
        url: '{% url "ajax_load_technician_services" %}',
        data: {
          technician_id: technicianId,
        },
        success: function (data) {
          console.log("Received services data:", data);
          $("#id_service").html('');
          if (Array.isArray(data) && data.length > 0) {
            $.each(data, function (index, service) {
              $("#id_service").append($("<option></option>").val(service.id).html(service.name));
            });
          } else {
            $("#id_service").html('<option value="">No services available for this technician</option>');
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", status, error);
          console.error("Response Text:", xhr.responseText);
        },
      });
    }

    function updateSummary() {
      var summary = "";
      summary += `<li><span class="label">City:</span> <span class="value">${$("#id_city option:selected").text()}</span></li>`;
      summary += `<li><span class="label">Area:</span> <span class="value">${$("#id_area option:selected").text()}</span></li>`;
      summary += `<li><span class="label">Technician:</span> <span class="value">${$("#id_technician option:selected").text()}</span></li>`;
      summary += `<li><span class="label">Customer:</span> <span class="value">${$("#id_name").val()} (${$("#id_mobile_number").val()})</span></li>`;
      summary += `<li><span class="label">Date:</span> <span class="value">${formatDateForDisplay($("#id_date").val())}</span></li>`;
      summary += `<li><span class="label">Time Slot:</span> <span class="value">${$(".time-slot.selected").text()}</span></li>`;
      summary += `<li><span class="label">Service(s):</span> <span class="value">${$("#id_service option:selected").map(function() { return $(this).text(); }).get().join(", ")}</span></li>`;
      summary += `<li><span class="label">Notes:</span> <span class="value">${$("#id_notes").val()}</span></li>`;
      $("#appointmentSummary").html(summary);
    }

    function formatDateForDisplay(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    $("#appointmentForm").change(updateSummary);

    // Pre-select values if in edit mode
    {% if edit_mode %}
      var cityId = "{{ initial_data.city }}";
      var areaId = "{{ initial_data.area }}";
      var technicianId = "{{ initial_data.technician }}";
      var date = "{{ initial_data.date|date:'Y-m-d' }}";
      var slotId = "{{ initial_data.slot }}";
      var services = {{ initial_data.service|safe }};

      $("#id_city").val(cityId).trigger('change');
      
      // Use setTimeout to ensure area options are loaded before selecting
      setTimeout(function() {
        $("#id_area").val(areaId).trigger('change');
        
        // Use another setTimeout for technician selection
        setTimeout(function() {
          $("#id_technician").val(technicianId).trigger('change');
          
          // Load time slots for the selected date
          loadTimeSlots(date);
          
          // Pre-select the time slot
          setTimeout(function() {
            $(".time-slot").each(function() {
              if ($(this).data('slot-id') == slotId) {
                $(this).addClass('selected');
              }
            });
          }, 500);
          
          // Pre-select services
          $("#id_service").val(services);
          
          // Update the summary
          updateSummary();
        }, 500);
      }, 500);
    {% endif %}

  });
</script>
{% endblock extra_js %}